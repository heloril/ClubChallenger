@page
@model ManagementModel
@{
    ViewData["Title"] = "Race Management - Club Challenger";
}

<div class="container-fluid mt-3">
    <h2 class="mb-4"><i class="bi bi-speedometer2"></i> Race Management Dashboard</h2>

    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert @(Model.IsError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
            @Model.StatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="managementTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(Model.ActiveTab == "upload" ? "active" : "")" 
                    id="upload-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#upload-content" 
                    type="button" 
                    role="tab">
                <i class="bi bi-upload"></i> Upload & Process Race
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(Model.ActiveTab == "races" ? "active" : "")" 
                    id="races-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#races-content" 
                    type="button" 
                    role="tab">
                <i class="bi bi-list-check"></i> View Races
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(Model.ActiveTab == "general" ? "active" : "")" 
                    id="general-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#general-content" 
                    type="button" 
                    role="tab">
                <i class="bi bi-trophy"></i> General Classification
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="managementTabContent">
        
        <!-- TAB 1: Upload & Process Race -->
        <div class="tab-pane fade @(Model.ActiveTab == "upload" ? "show active" : "")" 
             id="upload-content" 
             role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4><i class="bi bi-upload"></i> Upload & Process Race</h4>
                        </div>
                        <div class="card-body">
                            <form method="post" enctype="multipart/form-data" asp-page-handler="Upload">
                                <div class="mb-3">
                                    <label asp-for="UploadedFile" class="form-label">Race Result File (Excel or PDF)</label>
                                    <input asp-for="UploadedFile" class="form-control" type="file" accept=".xlsx,.pdf" required />
                                    <span asp-validation-for="UploadedFile" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="RaceName" class="form-label">Race Name</label>
                                    <input asp-for="RaceName" class="form-control" placeholder="Enter race name" required />
                                    <span asp-validation-for="RaceName" class="text-danger"></span>
                                </div>

                                <div class="form-check mb-3">
                                    <input asp-for="IsHorsChallenge" class="form-check-input" type="checkbox" />
                                    <label asp-for="IsHorsChallenge" class="form-check-label">
                                        Hors Challenge (Not part of the challenge)
                                    </label>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Year" class="form-label">Year</label>
                                    <select asp-for="Year" class="form-select" asp-items="Model.Years">
                                        <option value="">Select Year</option>
                                    </select>
                                    <span asp-validation-for="Year" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="RaceNumber" class="form-label">Race Number</label>
                                    <input asp-for="RaceNumber" class="form-control" type="number" min="1" placeholder="1" required />
                                    <span asp-validation-for="RaceNumber" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="DistanceKm" class="form-label">Distance (km)</label>
                                    <input asp-for="DistanceKm" class="form-control" type="number" min="1" placeholder="10" required />
                                    <span asp-validation-for="DistanceKm" class="text-danger"></span>
                                </div>

                                <button type="submit" class="btn btn-success w-100 btn-lg">
                                    <i class="bi bi-check-circle"></i> Process Race
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h4><i class="bi bi-info-circle"></i> Instructions</h4>
                        </div>
                        <div class="card-body">
                            <h5>Step 1: Select File</h5>
                            <p>Choose an Excel (.xlsx) or PDF file containing race results.</p>

                            <h5>Step 2: Enter Race Information</h5>
                            <ul>
                                <li><strong>Race Name</strong>: Name of the race</li>
                                <li><strong>Year</strong>: Year of the race (required unless "Hors Challenge")</li>
                                <li><strong>Race Number</strong>: Sequential number for the challenge</li>
                                <li><strong>Distance</strong>: Race distance in kilometers</li>
                            </ul>

                            <h5>Step 3: Process</h5>
                            <p>Click "Process Race" to analyze results, calculate points, and generate classifications.</p>

                            <div class="alert alert-warning mt-3">
                                <strong>Requirements:</strong>
                                <ul class="mb-0">
                                    <li>Excel/PDF file must contain participant names</li>
                                    <li>File should include timing information</li>
                                    <li>Members must be registered in the system</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: View Races -->
        <div class="tab-pane fade @(Model.ActiveTab == "races" ? "show active" : "")" 
             id="races-content" 
             role="tabpanel">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="bi bi-trophy"></i> Race Management & Classifications</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5>All Races</h5>
                            <div class="btn-group mb-3" role="group">
                                <a asp-page="/Management" asp-route-tab="races" class="btn btn-outline-primary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </a>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Year</th>
                                            <th>Race #</th>
                                            <th>Name</th>
                                            <th>Distance (km)</th>
                                            <th>Status</th>
                                            <th>Processed Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.Races.Any())
                                        {
                                            @foreach (var race in Model.Races)
                                            {
                                                <tr>
                                                    <td>@race.Id</td>
                                                    <td>@race.Year</td>
                                                    <td>@race.RaceNumber</td>
                                                    <td>@race.Name</td>
                                                    <td>@race.DistanceKm</td>
                                                    <td><span class="badge bg-success">@race.Status</span></td>
                                                    <td>@race.ProcessedDate?.ToString("yyyy-MM-dd HH:mm")</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <a asp-page="/Management" asp-route-tab="races" asp-route-raceId="@race.Id" class="btn btn-info">
                                                                <i class="bi bi-eye"></i> View
                                                            </a>
                                                            <a asp-page="/Management" asp-route-raceId="@race.Id" asp-page-handler="Download" class="btn btn-primary">
                                                                <i class="bi bi-download"></i> Download
                                                            </a>
                                                            <a asp-page="/Management" asp-route-raceId="@race.Id" asp-page-handler="Delete" 
                                                               class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this race?');">
                                                                <i class="bi bi-trash"></i> Delete
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="8" class="text-center">No races found. Process a race first.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Race Classifications -->
                    @if (Model.SelectedRaceId.HasValue && Model.Classifications.Any())
                    {
                        <hr />
                        <div class="row">
                            <div class="col-md-12">
                                <h5>Race Results - @Model.Races.FirstOrDefault(r => r.Id == Model.SelectedRaceId)?.Name</h5>
                                
                                <!-- Filters -->
                                <div class="card mb-3 bg-light">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>Filter by Membership:</strong>
                                                <div class="btn-group ms-2" role="group">
                                                    <a asp-page="/Management" asp-route-tab="races" asp-route-raceId="@Model.SelectedRaceId" asp-route-memberFilter="" 
                                                       class="btn btn-sm @(Model.MemberFilter == null ? "btn-primary" : "btn-outline-primary")">All</a>
                                                    <a asp-page="/Management" asp-route-tab="races" asp-route-raceId="@Model.SelectedRaceId" asp-route-memberFilter="true" 
                                                       class="btn btn-sm @(Model.MemberFilter == true ? "btn-primary" : "btn-outline-primary")">Members Only</a>
                                                    <a asp-page="/Management" asp-route-tab="races" asp-route-raceId="@Model.SelectedRaceId" asp-route-memberFilter="false" 
                                                       class="btn btn-sm @(Model.MemberFilter == false ? "btn-primary" : "btn-outline-primary")">Non-Members</a>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Filter by Challenge:</strong>
                                                <div class="btn-group ms-2" role="group">
                                                    <a asp-page="/Management" asp-route-tab="races" asp-route-raceId="@Model.SelectedRaceId" asp-route-challengerFilter="" 
                                                       class="btn btn-sm @(Model.ChallengerFilter == null ? "btn-warning" : "btn-outline-warning")">All</a>
                                                    <a asp-page="/Management" asp-route-tab="races" asp-route-raceId="@Model.SelectedRaceId" asp-route-challengerFilter="true" 
                                                       class="btn btn-sm @(Model.ChallengerFilter == true ? "btn-warning" : "btn-outline-warning")">Challengers</a>
                                                    <a asp-page="/Management" asp-route-tab="races" asp-route-raceId="@Model.SelectedRaceId" asp-route-challengerFilter="false" 
                                                       class="btn btn-sm @(Model.ChallengerFilter == false ? "btn-warning" : "btn-outline-warning")">Non-Challengers</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Rank</th>
                                                <th>Position</th>
                                                <th>First Name</th>
                                                <th>Last Name</th>
                                                <th>Sex</th>
                                                <th>Pos/Sex</th>
                                                <th>Category</th>
                                                <th>Pos/Cat</th>
                                                <th>Team</th>
                                                <th>Points</th>
                                                <th>Time</th>
                                                <th>Time/km</th>
                                                <th>Speed</th>
                                                <th>Member</th>
                                                <th>Challenger</th>
                                                <th>Bonus KM</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var classification in Model.Classifications)
                                            {
                                                <tr>
                                                    <td>@classification.Id</td>
                                                    <td>@classification.Position</td>
                                                    <td>@classification.MemberFirstName</td>
                                                    <td>@classification.MemberLastName</td>
                                                    <td>@classification.Sex</td>
                                                    <td>@classification.PositionBySex</td>
                                                    <td>@classification.AgeCategory</td>
                                                    <td>@classification.PositionByCategory</td>
                                                    <td>@classification.Team</td>
                                                    <td><strong>@classification.Points</strong></td>
                                                    <td>@(classification.RaceTime.HasValue ? classification.RaceTime.Value.ToString(@"hh\:mm\:ss") : "-")</td>
                                                    <td>@(classification.TimePerKm.HasValue ? classification.TimePerKm.Value.ToString(@"mm\:ss") : "-")</td>
                                                    <td>@(classification.Speed.HasValue ? $"{classification.Speed.Value:F2} km/h" : "-")</td>
                                                    <td>@(classification.IsMember ? "✓" : "")</td>
                                                    <td>@(classification.IsChallenger ? "✓" : "")</td>
                                                    <td>@classification.BonusKm</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- TAB 3: General Classification -->
        <div class="tab-pane fade @(Model.ActiveTab == "general" ? "show active" : "")" 
             id="general-content" 
             role="tabpanel">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4><i class="bi bi-trophy-fill"></i> General Classification</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="yearSelect" class="form-label">Select Year:</label>
                        <select id="yearSelect" class="form-select w-auto" onchange="location.href='?tab=general&year=' + this.value">
                            @foreach (var year in Model.Years)
                            {
                                <option value="@year.Value" selected="@(year.Value == Model.SelectedYear.ToString())">@year.Text</option>
                            }
                        </select>
                    </div>

                    @if (Model.GeneralClassifications.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Rank</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Total Points</th>
                                        <th>Bonus KM</th>
                                        <th>Races</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int rank = 1;
                                    }
                                    @foreach (var gc in Model.GeneralClassifications)
                                    {
                                        <tr>
                                            <td><strong>@rank</strong></td>
                                            <td>@gc.MemberFirstName</td>
                                            <td>@gc.MemberLastName</td>
                                            <td><strong class="text-primary">@gc.TotalPoints</strong></td>
                                            <td>@gc.TotalBonusKm</td>
                                            <td>@gc.RaceCount</td>
                                        </tr>
                                        rank++;
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            No general classification data available for the selected year.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
