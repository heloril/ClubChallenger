<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>CKEditor - Email Editor</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        #editor-container {
            background-color: white;
            padding: 0;
            min-height: 500px;
        }
        .status-bar {
            background-color: #e3f2fd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #1976d2;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 16px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">
        ‚è≥ Loading CKEditor from CDN... Please wait (this may take a few seconds)
    </div>

    <div id="loadingIndicator" class="loading">
        <div class="spinner"></div>
        <p>Loading CKEditor 4...</p>
        <p style="font-size: 12px; color: #666;">This requires an Internet connection</p>
    </div>

    <div id="editor-container" style="display: none;">
        <textarea id="editor" name="editor">
            <h1>üìß Email Editor Ready</h1>
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Click <strong>"Generate Email Template"</strong> in the main window</li>
                <li>Click <strong>"üîÑ Load Template"</strong> to load it here</li>
                <li>Edit your email using the toolbar above</li>
                <li>Changes are saved automatically</li>
            </ol>
            <p><em>CKEditor supports all HTML formatting including tables, lists, links, and more!</em></p>
        </textarea>
    </div>

    <div id="errorContainer"></div>

    <!-- CKEditor 4 from CDN (100% Free) -->
    <script src="https://cdn.ckeditor.com/4.22.1/standard-all/ckeditor.js" 
            onerror="handleCDNError()"></script>

    <script>
        var editor;
        var isReady = false;
        var autoSaveTimeout;
        var loadTimeout;

        // Set a timeout to show error if CKEditor doesn't load within 10 seconds
        loadTimeout = setTimeout(function() {
            if (!isReady) {
                showError("CKEditor failed to load. Please check your Internet connection or contact support.");
            }
        }, 10000);

        function handleCDNError() {
            clearTimeout(loadTimeout);
            showError("Failed to load CKEditor from CDN. Please check your Internet connection.");
        }

        function showError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('statusBar').innerHTML = '‚ùå ' + message;
            document.getElementById('statusBar').style.backgroundColor = '#ffebee';
            document.getElementById('statusBar').style.color = '#c62828';

            var errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = '<strong>Error:</strong> ' + message + 
                '<br><br><strong>Troubleshooting:</strong>' +
                '<ul>' +
                '<li>Check your Internet connection</li>' +
                '<li>Check if your firewall is blocking cdn.ckeditor.com</li>' +
                '<li>Try refreshing the page</li>' +
                '<li>Contact your IT support if the problem persists</li>' +
                '</ul>';
            document.getElementById('errorContainer').appendChild(errorDiv);
        }

        // Check if CKEDITOR is available
        if (typeof CKEDITOR !== 'undefined') {
            // Initialize CKEditor
            CKEDITOR.replace('editor', {
            // Toolbar configuration - optimized for email editing
            toolbar: [
                { name: 'document', items: ['Source', '-', 'Preview'] },
                { name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo'] },
                { name: 'editing', items: ['Find', 'Replace', '-', 'SelectAll'] },
                '/',
                { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat'] },
                { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote'] },
                { name: 'links', items: ['Link', 'Unlink'] },
                { name: 'insert', items: ['Image', 'Table', 'HorizontalRule', 'SpecialChar'] },
                '/',
                { name: 'styles', items: ['Styles', 'Format', 'Font', 'FontSize'] },
                { name: 'colors', items: ['TextColor', 'BGColor'] },
                { name: 'align', items: ['JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
                { name: 'tools', items: ['Maximize', 'ShowBlocks'] }
            ],

            // Height
            height: 500,

            // Email-friendly settings
            removePlugins: 'elementspath',
            resize_enabled: true,

            // Allow all content (important for email HTML)
            allowedContent: true,
            extraAllowedContent: '*(*);*{*}',

            // Default font
            font_defaultLabel: 'Arial',
            fontSize_defaultLabel: '14px',

            // Content style
            contentsCss: [
                'body { font-family: Arial, sans-serif; font-size: 14px; padding: 20px; }',
                'table { border-collapse: collapse; width: 100%; margin: 10px 0; }',
                'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }',
                'th { background-color: #FF9800; color: white; font-weight: bold; }',
                'tr:nth-child(even) { background-color: #f2f2f2; }'
            ],

            // Table settings
            table_defaultCellPadding: 8,
            table_defaultCellSpacing: 0,

            // Events
            on: {
                instanceReady: function(evt) {
                    clearTimeout(loadTimeout);
                    editor = evt.editor;
                    isReady = true;

                    // Hide loading indicator and show editor
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('editor-container').style.display = 'block';

                    // Notify C# that editor is ready
                    if (window.chrome && window.chrome.webview) {
                        window.chrome.webview.postMessage({ 
                            type: 'editorReady' 
                        });
                    }

                    updateStatus('‚úÖ CKEditor ready - Click "Load Template" to start editing');
                },

                change: function(evt) {
                    if (isReady) {
                        // Debounce auto-save
                        clearTimeout(autoSaveTimeout);
                        autoSaveTimeout = setTimeout(function() {
                            saveContent();
                        }, 1000);
                    }
                },

                blur: function(evt) {
                    if (isReady) {
                        saveContent();
                    }
                }
            }
        });
        } else {
            // CKEDITOR not loaded yet, will be handled by timeout
            console.log('Waiting for CKEDITOR to load...');
        }

        // Save content to C#
        function saveContent() {
            if (editor && window.chrome && window.chrome.webview) {
                var html = editor.getData();
                window.chrome.webview.postMessage({ 
                    type: 'contentChanged', 
                    html: html 
                });
                updateStatus('üíæ Content saved');
            }
        }

        // Set content from C# (called by C#)
        function setContent(html) {
            if (editor && html) {
                editor.setData(html);
                updateStatus('üìß Template loaded successfully');
            }
        }

        // Get content (called by C#)
        function getContent() {
            if (editor) {
                return editor.getData();
            }
            return '';
        }

        // Insert a table at cursor (called by C#)
        function insertTable(rows, cols) {
            if (editor) {
                var tableHtml = '<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">\n';

                // Header row
                tableHtml += '<thead>\n<tr style="background-color: #FF9800; color: white;">\n';
                for (var i = 0; i < cols; i++) {
                    tableHtml += '<th style="border: 1px solid #ddd; padding: 8px;">Header ' + (i + 1) + '</th>\n';
                }
                tableHtml += '</tr>\n</thead>\n';

                // Body rows
                tableHtml += '<tbody>\n';
                for (var r = 0; r < rows - 1; r++) {
                    var rowStyle = (r % 2 === 0) ? ' style="background-color: #f2f2f2;"' : '';
                    tableHtml += '<tr' + rowStyle + '>\n';
                    for (var c = 0; c < cols; c++) {
                        tableHtml += '<td style="border: 1px solid #ddd; padding: 8px;">Cell</td>\n';
                    }
                    tableHtml += '</tr>\n';
                }
                tableHtml += '</tbody>\n';
                tableHtml += '</table>\n<p>&nbsp;</p>\n';

                editor.insertHtml(tableHtml);
                updateStatus('üìä Table inserted');
            }
        }

        // Update status bar
        function updateStatus(message) {
            var statusBar = document.getElementById('statusBar');
            if (statusBar) {
                statusBar.textContent = message;
                // Don't auto-hide success messages
                if (message.indexOf('‚ùå') === -1 && message.indexOf('‚è≥') === -1) {
                    setTimeout(function() {
                        if (statusBar.textContent === message) {
                            statusBar.textContent = 'üìß CKEditor ready - Edit your email';
                        }
                    }, 3000);
                }
            }
        }

        // Initialize or show error
        if (typeof CKEDITOR === 'undefined') {
            setTimeout(function() {
                if (typeof CKEDITOR === 'undefined') {
                    showError('CKEditor library failed to load from CDN.');
                }
            }, 5000);
        }

        // Log for debugging
        console.log('CKEditor initialization script loaded');
    </script>
</body>
</html>
