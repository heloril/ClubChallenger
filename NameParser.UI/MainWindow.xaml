<Window x:Class="NameParser.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
        xmlns:viewModels="clr-namespace:NameParser.UI.ViewModels"
        xmlns:converters="clr-namespace:NameParser.UI.Converters"
        xmlns:local="clr-namespace:NameParser.UI.Converters"
        Title="{Binding Localization[WindowTitle]}" Height="800" Width="1200"
        WindowStartupLocation="CenterScreen">

    <Window.DataContext>
        <viewModels:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <converters:StringToBoolConverter x:Key="StringToBoolConverter"/>

        <Style TargetType="TextBlock">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style TargetType="TextBox">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Height" Value="30"/>
        </Style>
        <Style TargetType="ComboBox">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Height" Value="30"/>
        </Style>
        <Style TargetType="Button">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="MinWidth" Value="100"/>
        </Style>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#2196F3" Padding="10" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="{Binding Localization[WindowTitle]}" FontSize="24" FontWeight="Bold" Foreground="White"/>

                <!-- Language Selector -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding Localization[Language]}" Foreground="White" Margin="0,0,5,0" VerticalAlignment="Center"/>
                    <ComboBox ItemsSource="{Binding AvailableLanguages}" 
                              SelectedValue="{Binding SelectedLanguage}"
                              SelectedValuePath="Code"
                              DisplayMemberPath="DisplayName"
                              Width="120"
                              Height="30"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content -->
        <TabControl Grid.Row="1">

            <!-- Upload and Process Tab -->
            <TabItem Header="{Binding Localization[TabUploadProcess]}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="450"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Input Form -->
                    <Border Grid.Column="0" BorderBrush="#CCCCCC" BorderThickness="1" Padding="10" Margin="5">
                        <StackPanel>
                            <TextBlock Text="{Binding Localization[RaceInformation]}" FontSize="18" FontWeight="Bold" Margin="5,5,5,15"/>

                            <!-- Race Event Selection -->
                            <GroupBox Header="Race Event" Margin="5">
                                <StackPanel>
                                    <TextBlock Text="Select the race event for which you want to upload results:" 
                                              TextWrapping="Wrap" Margin="0,0,0,10"/>
                                    <ComboBox ItemsSource="{Binding RaceEventsForSelection}"
                                             SelectedItem="{Binding SelectedUploadRaceEvent}">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                                    <TextBlock Text=" - " Margin="5,0"/>
                                                    <TextBlock Text="{Binding EventDate, StringFormat=\{0:dd/MM/yyyy\}}"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                            </GroupBox>

                            <!-- Distance Files Upload -->
                            <GroupBox Header="Upload Results by Distance" Margin="5">
                                <StackPanel>
                                    <TextBlock Text="Select a file for each distance (only distances with files will be processed):" 
                                              TextWrapping="Wrap" Margin="0,0,0,10" FontStyle="Italic"/>

                                    <ItemsControl ItemsSource="{Binding AvailableDistancesForUpload}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border BorderBrush="#E0E0E0" BorderThickness="1" Padding="10" Margin="0,5,0,5" Background="#FAFAFA">
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                        </Grid.RowDefinitions>

                                                        <TextBlock Grid.Row="0" FontWeight="Bold" FontSize="14" Margin="0,0,0,5">
                                                            <Run Text="Distance: "/>
                                                            <Run Text="{Binding DistanceKm, Mode=OneWay, StringFormat={}{0} km}" Foreground="#2196F3"/>
                                                        </TextBlock>

                                                        <TextBox Grid.Row="1" Text="{Binding FileName, Mode=OneWay}" IsReadOnly="True" 
                                                                Background="#FFFFFF" Margin="0,0,0,5"/>

                                                        <StackPanel Grid.Row="2" Orientation="Horizontal">
                                                            <Button Content="Browse File..." 
                                                                   Command="{Binding DataContext.BrowseDistanceFileCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                   CommandParameter="{Binding}"
                                                                   Width="100" Margin="0,0,5,0"/>
                                                            <TextBlock Text="{Binding StatusMessage}" 
                                                                      VerticalAlignment="Center" 
                                                                      FontStyle="Italic"
                                                                      Foreground="#666"/>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </GroupBox>

                            <!-- Process Button -->
                            <Button Content="Process All Selected Races" Command="{Binding ProcessAllDistancesCommand}" 
                                    FontSize="16" FontWeight="Bold" Height="45" Margin="5,15,5,5"
                                    Background="#4CAF50" Foreground="White">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                        <Style.Triggers>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter Property="Background" Value="#CCCCCC"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <!-- Processing Indicator -->
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="5"
                                        Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="{Binding Localization[Processing]}" FontStyle="Italic" Margin="5"/>
                                <ProgressBar IsIndeterminate="True" Width="100" Height="20"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Instructions -->
                    <Border Grid.Column="1" BorderBrush="#CCCCCC" BorderThickness="1" Padding="10" Margin="5">
                        <StackPanel>
                            <TextBlock Text="{Binding Localization[Instructions]}" FontSize="18" FontWeight="Bold" Margin="5,5,5,15"/>

                            <TextBlock TextWrapping="Wrap" Margin="5">
                                <Run Text="How to Process Race Results" FontWeight="Bold" FontSize="16"/>
                                <LineBreak/><LineBreak/>

                                <Run Text="Step 1: Select Race Event" FontWeight="Bold"/>
                                <LineBreak/>
                                <Run Text="Choose the race event from the dropdown. The event should already be created in the Race Event Management tab."/>
                                <LineBreak/><LineBreak/>

                                <Run Text="Step 2: Upload Result Files" FontWeight="Bold"/>
                                <LineBreak/>
                                <Run Text="For each distance that has results, click 'Browse File...' and select the Excel (.xlsx) or PDF file containing the race results."/>
                                <LineBreak/>
                                <Run Text="• You can upload results for one or more distances"/>
                                <LineBreak/>
                                <Run Text="• Distances without files will be skipped"/>
                                <LineBreak/><LineBreak/>

                                <Run Text="Step 3: Process" FontWeight="Bold"/>
                                <LineBreak/>
                                <Run Text="Click 'Process All Selected Races' to process all distances that have files attached."/>
                                <LineBreak/><LineBreak/>

                                <Run Text="Note:" FontWeight="Bold"/>
                                <LineBreak/>
                                <Run Text="• All races from the same event will share the same race number"/>
                                <LineBreak/>
                                <Run Text="• The system automatically assigns the next available race number"/>
                                <LineBreak/>
                                <Run Text="• Race year is taken from the event date"/>
                            </TextBlock>

                            <Border Background="#E3F2FD" Padding="10" Margin="5,20,5,5">
                                <StackPanel>
                                    <TextBlock Text="File Format Requirements" FontWeight="Bold" FontSize="14"/>
                                    <TextBlock Text="Excel (.xlsx) files:" FontWeight="SemiBold" Margin="0,5,0,0"/>
                                    <TextBlock Text="• Must contain columns: Position, Name, Time" TextWrapping="Wrap" Margin="5,2,5,0"/>
                                    <TextBlock Text="• Optional: Team, Category, Sex" TextWrapping="Wrap" Margin="5,2,5,0"/>

                                    <TextBlock Text="PDF files:" FontWeight="SemiBold" Margin="0,10,0,0"/>
                                    <TextBlock Text="• Must be text-based (not scanned images)" TextWrapping="Wrap" Margin="5,2,5,0"/>
                                    <TextBlock Text="• Should follow standard race result format" TextWrapping="Wrap" Margin="5,2,5,0"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Border>
                </Grid>
            </TabItem>

            <!-- Race Classification Tab -->
            <TabItem Header="{Binding Localization[TabRaceClassification]}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Race Event Selection -->
                    <GroupBox Grid.Row="0" Header="Select Race Event" Margin="5">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <ComboBox Grid.Column="0" ItemsSource="{Binding RaceEventsForSelection}"
                                     SelectedItem="{Binding SelectedRaceEventForClassification}"
                                     Margin="5">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,10,0"/>
                                            <TextBlock Text="-" Margin="0,0,5,0"/>
                                            <TextBlock Text="{Binding EventDate, StringFormat=\{0:dd/MM/yyyy\}}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <Button Grid.Column="1" Content="{Binding Localization[RefreshRaces]}" 
                                   Command="{Binding RefreshRacesCommand}" Margin="5"/>
                        </Grid>
                    </GroupBox>

                    <!-- Races in Selected Event -->
                    <GroupBox Grid.Row="1" Header="Races in Event (Ordered by Distance)" Margin="5">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Action Buttons -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                                <Button Content="View All Classifications" Command="{Binding ViewClassificationCommand}" 
                                       Background="#2196F3" Foreground="White"/>
                                <Button Content="🗑️ Delete Selected Race" Command="{Binding DeleteRaceCommand}" 
                                       Background="#F44336" Foreground="White" 
                                       ToolTip="Delete the selected race and all its classifications"/>
                                <Button Content="Reprocess All Races" Command="{Binding ReprocessRaceCommand}" 
                                       Background="#FF9800" Foreground="White" 
                                       ToolTip="Reprocess all races in this event"/>

                                <!-- Export Results Menu Button -->
                                <Button Content="📤 Export Results ▼" Background="#4CAF50" Foreground="White" ToolTip="Export race results">
                                    <Button.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Export to HTML (Email)" Command="{Binding ExportToHtmlCommand}">
                                                <MenuItem.Icon>
                                                    <TextBlock Text="📧" FontSize="14"/>
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <MenuItem Header="Export to Excel (.xlsx)" Command="{Binding ExportToExcelCommand}">
                                                <MenuItem.Icon>
                                                    <TextBlock Text="📊" FontSize="14"/>
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <MenuItem Header="Export to Word (.docx)" Command="{Binding ExportToWordCommand}">
                                                <MenuItem.Icon>
                                                    <TextBlock Text="📝" FontSize="14"/>
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <Separator/>
                                            <MenuItem Header="Export Summary (Quick)" Command="{Binding ExportSummaryCommand}">
                                                <MenuItem.Icon>
                                                    <TextBlock Text="⚡" FontSize="14"/>
                                                </MenuItem.Icon>
                                            </MenuItem>
                                        </ContextMenu>
                                    </Button.ContextMenu>
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                            <EventSetter Event="Click" Handler="ExportButton_Click"/>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <Button Content="📱 Share to Facebook" Command="{Binding ShareRaceToFacebookCommand}" 
                                       Background="#1877F2" Foreground="White" 
                                       ToolTip="Share race event results to Facebook page"/>
                            </StackPanel>

                            <!-- Races Grid -->
                            <DataGrid Grid.Row="1" ItemsSource="{Binding RacesInSelectedEvent}" 
                                     SelectedItem="{Binding SelectedRace}"
                                     AutoGenerateColumns="False" 
                                     IsReadOnly="True"
                                     MaxHeight="150"
                                     Margin="5">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Distance (km)" Binding="{Binding DistanceKm}" Width="100"/>
                                    <DataGridTextColumn Header="Race Name" Binding="{Binding Name}" Width="*"/>
                                    <DataGridTextColumn Header="Race #" Binding="{Binding RaceNumber}" Width="70"/>
                                    <DataGridTextColumn Header="Year" Binding="{Binding Year}" Width="70"/>
                                    <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="100"/>
                                    <DataGridTextColumn Header="Processed Date" Binding="{Binding ProcessedDate, StringFormat='yyyy-MM-dd HH:mm'}" Width="150"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </GroupBox>

                    <!-- Race Classifications -->
                    <GroupBox Grid.Row="2" Header="{Binding Localization[RaceResults]}" Margin="5">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Member and Challenger Filters -->
                            <Border Grid.Row="0" Background="#F5F5F5" Padding="10" Margin="5">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                        <TextBlock Text="{Binding Localization[FilterByMembership]}" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,15,0"/>
                                        <Button Content="{Binding Localization[AllParticipants]}" Command="{Binding ShowAllCommand}" Width="140" Margin="0,0,5,0"/>
                                        <Button Content="{Binding Localization[MembersOnly]}" Command="{Binding ShowOnlyMembersCommand}" Width="140" Margin="0,0,5,0"/>
                                        <Button Content="{Binding Localization[NonMembersOnly]}" Command="{Binding ShowOnlyNonMembersCommand}" Width="160" Margin="0,0,0,0"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding Localization[FilterByChallenge]}" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,15,0" Width="140"/>
                                        <Button Content="{Binding Localization[ChallengersOnly]}" Command="{Binding ShowOnlyChallengersCommand}" Width="140" Margin="0,0,5,0"/>
                                        <Button Content="{Binding Localization[NonChallengersOnly]}" Command="{Binding ShowOnlyNonChallengersCommand}" Width="160" Margin="0,0,0,0"/>
                                        <TextBlock Text="{Binding Localization[WinnerAlwaysShown]}" 
                                                   FontStyle="Italic" 
                                                   VerticalAlignment="Center" 
                                                   Margin="15,0,0,0"
                                                   Foreground="#666"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- DataGrid -->
                            <DataGrid Grid.Row="1" ItemsSource="{Binding Classifications}" 
                                      AutoGenerateColumns="False" 
                                      IsReadOnly="True"
                                      Margin="5">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[Rank], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding Id}" Width="60"/>
                                    <DataGridTextColumn Header="Distance" Binding="{Binding Race.DistanceKm, StringFormat={}{0} km}" Width="80"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[Position], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding Position}" Width="70"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[FirstName], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding MemberFirstName}" Width="*"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[LastName], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding MemberLastName}" Width="*"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[Sex], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding Sex}" Width="50"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[PosBySex], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding PositionBySex}" Width="70"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[Category], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding AgeCategory}" Width="80"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[PosByCategory], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding PositionByCategory}" Width="70"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[Team], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding Team}" Width="120"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[Points], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding Points}" Width="80"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[RaceTime], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding RaceTime, Converter={StaticResource TimeSpanToStringConverter}}" Width="100"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[TimePerKm], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding TimePerKm, Converter={StaticResource TimeSpanToStringConverter}}" Width="90"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[Speed], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding Speed, StringFormat={}{0:F2}}" Width="100"/>
                                    <DataGridCheckBoxColumn Header="{Binding DataContext.Localization[Member], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding IsMember}" Width="70" IsReadOnly="True"/>
                                    <DataGridCheckBoxColumn Header="{Binding DataContext.Localization[Challenger], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding IsChallenger}" Width="80" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="{Binding DataContext.Localization[BonusKM], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding BonusKm}" Width="90"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </GroupBox>
                </Grid>
            </TabItem>

            <!-- Challenger Classification Tab -->
            <TabItem Header="{Binding Localization[TabChallengerClassification]}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Challenge Selection and Actions -->
                    <Border Grid.Row="0" Background="#FFF3E0" Padding="10" Margin="5">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                <TextBlock Text="Select Challenge:" FontWeight="Bold" FontSize="14" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                <ComboBox ItemsSource="{Binding ChallengesForClassification}" 
                                          SelectedItem="{Binding SelectedChallengeForClassification}" 
                                          Width="300"
                                          Height="30">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,10,0"/>
                                                <TextBlock Text="-" Margin="0,0,5,0"/>
                                                <TextBlock Text="{Binding Year}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <Button Content="{Binding Localization[LoadChallengers]}" Command="{Binding ViewChallengerClassificationCommand}" Margin="10,0,10,0"/>

                                <!-- Export Menu Button -->
                                <Button Content="📤 Export ▼" Background="#FF9800" Foreground="White" Margin="0,0,10,0" ToolTip="Export challenger classification">
                                    <Button.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="📊 Summary (HTML)" Command="{Binding ExportChallengerSummaryHtmlCommand}">
                                                <MenuItem.ToolTip>
                                                    <TextBlock Text="Export summary with Name, Points, Races, and KMs only"/>
                                                </MenuItem.ToolTip>
                                            </MenuItem>
                                            <MenuItem Header="📊 Summary (Excel)" Command="{Binding ExportChallengerSummaryExcelCommand}">
                                                <MenuItem.ToolTip>
                                                    <TextBlock Text="Export summary spreadsheet with basic statistics"/>
                                                </MenuItem.ToolTip>
                                            </MenuItem>
                                            <MenuItem Header="📊 Summary (Word)" Command="{Binding ExportChallengerSummaryWordCommand}">
                                                <MenuItem.ToolTip>
                                                    <TextBlock Text="Export summary document for printing"/>
                                                </MenuItem.ToolTip>
                                            </MenuItem>
                                            <MenuItem Header="📊 Summary (PDF)" Command="{Binding ExportChallengerSummaryPdfCommand}">
                                                <MenuItem.ToolTip>
                                                    <TextBlock Text="Export summary as PDF for easy sharing and printing"/>
                                                </MenuItem.ToolTip>
                                            </MenuItem>
                                            <Separator/>
                                            <MenuItem Header="📋 Detailed (HTML)" Command="{Binding ExportChallengerDetailedHtmlCommand}">
                                                <MenuItem.ToolTip>
                                                    <TextBlock Text="Export complete view with race-by-race details"/>
                                                </MenuItem.ToolTip>
                                            </MenuItem>
                                            <MenuItem Header="📋 Detailed (Excel)" Command="{Binding ExportChallengerDetailedExcelCommand}">
                                                <MenuItem.ToolTip>
                                                    <TextBlock Text="Export detailed spreadsheet with all race information"/>
                                                </MenuItem.ToolTip>
                                            </MenuItem>
                                            <MenuItem Header="📋 Detailed (Word)" Command="{Binding ExportChallengerDetailedWordCommand}">
                                                <MenuItem.ToolTip>
                                                    <TextBlock Text="Export complete document with race-by-race breakdown"/>
                                                </MenuItem.ToolTip>
                                            </MenuItem>
                                            <MenuItem Header="📋 Detailed (PDF)" Command="{Binding ExportChallengerDetailedPdfCommand}">
                                                <MenuItem.ToolTip>
                                                    <TextBlock Text="Export complete PDF with race-by-race breakdown"/>
                                                </MenuItem.ToolTip>
                                            </MenuItem>
                                        </ContextMenu>
                                    </Button.ContextMenu>
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                            <EventSetter Event="Click" Handler="ChallengerExportButton_Click"/>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <Button Content="📱 Share to Facebook" Command="{Binding ShareChallengeToFacebookCommand}" Background="#1877F2" Foreground="White" ToolTip="Share challenge standings to Facebook page"/>
                            </StackPanel>
                            <TextBlock Text="Select a challenge to view the challenger rankings. Points are calculated from the best 7 races plus bonus kilometers." 
                                       FontStyle="Italic" 
                                       Foreground="#666"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                    </Border>

                    <!-- Challenger Classifications -->
                    <GroupBox Grid.Row="1" Header="{Binding Localization[ChallengerClassificationResults]}" Margin="5">
                        <ScrollViewer>
                            <ItemsControl ItemsSource="{Binding ChallengerClassifications}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="#DDDDDD" BorderThickness="1" Margin="5" Padding="10">
                                            <StackPanel>
                                                <!-- Challenger Summary -->
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,20,0">
                                                        <TextBlock Text="🥇" FontSize="20" Margin="0,0,10,0" Visibility="{Binding RankByPoints, Converter={StaticResource RankToVisibilityConverter}, ConverterParameter=1}"/>
                                                        <TextBlock Text="🥈" FontSize="20" Margin="0,0,10,0" Visibility="{Binding RankByPoints, Converter={StaticResource RankToVisibilityConverter}, ConverterParameter=2}"/>
                                                        <TextBlock Text="🥉" FontSize="20" Margin="0,0,10,0" Visibility="{Binding RankByPoints, Converter={StaticResource RankToVisibilityConverter}, ConverterParameter=3}"/>
                                                        <TextBlock Text="{Binding RankByPoints, StringFormat='#{0}'}" FontSize="18" FontWeight="Bold" Foreground="#FF9800" VerticalAlignment="Center"/>
                                                    </StackPanel>

                                                    <StackPanel Grid.Column="1">
                                                        <TextBlock FontSize="16" FontWeight="Bold">
                                                            <Run Text="{Binding ChallengerFirstName}"/>
                                                            <Run Text="{Binding ChallengerLastName}"/>
                                                        </TextBlock>
                                                        <TextBlock Text="{Binding Team}" FontStyle="Italic" Foreground="#666"/>
                                                    </StackPanel>

                                                    <StackPanel Grid.Column="2" HorizontalAlignment="Right">
                                                        <TextBlock>
                                                            <Run Text="{Binding DataContext.Localization[PointsWithBreakdown], Mode=OneWay, RelativeSource={RelativeSource AncestorType=Window}}" FontWeight="Bold"/>
                                                            <Run Text="{Binding TotalPoints}" FontSize="16" FontWeight="Bold" Foreground="#FF9800"/>
                                                            <Run Text=" (" Foreground="#666"/>
                                                            <Run Text="{Binding DataContext.Localization[Best7], Mode=OneWay, RelativeSource={RelativeSource AncestorType=Window}}" Foreground="#666"/>
                                                            <Run Text="{Binding Best7RacesPoints}" Foreground="#666"/>
                                                            <Run Text=" + " Foreground="#666"/>
                                                            <Run Text="{Binding DataContext.Localization[Bonus], Mode=OneWay, RelativeSource={RelativeSource AncestorType=Window}}" Foreground="#666"/>
                                                            <Run Text="{Binding TotalBonusKm}" Foreground="#666"/>
                                                            <Run Text=")" Foreground="#666"/>
                                                        </TextBlock>
                                                        <TextBlock>
                                                            <Run Text="{Binding DataContext.Localization[KMsRank], Mode=OneWay, RelativeSource={RelativeSource AncestorType=Window}}" FontWeight="Bold"/>
                                                            <Run Text="{Binding RankByKms, StringFormat='#{0}'}"/>
                                                            <Run Text=" - "/>
                                                            <Run Text="{Binding DataContext.Localization[Total], Mode=OneWay, RelativeSource={RelativeSource AncestorType=Window}}" FontWeight="Bold"/>
                                                            <Run Text="{Binding TotalKilometers, StringFormat={}{0} km}"/>
                                                        </TextBlock>
                                                        <TextBlock>
                                                            <Run Text="{Binding DataContext.Localization[Races], Mode=OneWay, RelativeSource={RelativeSource AncestorType=Window}}" FontWeight="Bold"/>
                                                            <Run Text="{Binding RaceCount}"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Grid>

                                                <!-- Race by Race Details -->
                                                <TextBlock Text="{Binding DataContext.Localization[RaceByRace], RelativeSource={RelativeSource AncestorType=Window}}" FontWeight="Bold" Margin="0,10,0,5"/>
                                                <DataGrid ItemsSource="{Binding RaceDetails}" 
                                                          AutoGenerateColumns="False" 
                                                          IsReadOnly="True"
                                                          HeadersVisibility="Column"
                                                          GridLinesVisibility="Horizontal"
                                                          Margin="0,0,0,5">
                                                    <DataGrid.Resources>
                                                        <Style TargetType="DataGridRow">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsInBest7}" Value="True">
                                                                    <Setter Property="Background" Value="#C8E6C9"/>
                                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </DataGrid.Resources>
                                                    <DataGrid.Columns>
                                                        <DataGridTextColumn Header="#" Binding="{Binding RaceNumber}" Width="40"/>
                                                        <DataGridTextColumn Header="{Binding DataContext.Localization[Race], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding RaceName}" Width="*"/>
                                                        <DataGridTextColumn Header="{Binding DataContext.Localization[Distance], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding DistanceKm, StringFormat={}{0} km}" Width="80"/>
                                                        <DataGridTextColumn Header="{Binding DataContext.Localization[Position], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding Position}" Width="70"/>
                                                        <DataGridTextColumn Header="{Binding DataContext.Localization[Points], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding Points}" Width="70"/>
                                                        <DataGridTextColumn Header="{Binding DataContext.Localization[Bonus], RelativeSource={RelativeSource AncestorType=Window}}" Binding="{Binding BonusKm}" Width="70"/>
                                                        <DataGridTextColumn Header="{Binding DataContext.Localization[IsInBest7], RelativeSource={RelativeSource AncestorType=Window}}" Width="60">
                                                            <DataGridTextColumn.Binding>
                                                                <Binding Path="IsInBest7">
                                                                    <Binding.Converter>
                                                                        <local:BoolToYesNoConverter/>
                                                                    </Binding.Converter>
                                                                </Binding>
                                                            </DataGridTextColumn.Binding>
                                                        </DataGridTextColumn>
                                                    </DataGrid.Columns>
                                                </DataGrid>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </GroupBox>
                </Grid>
            </TabItem>

            <!-- Challenge Management Tab -->
            <TabItem Header="Challenge Management">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Challenge Form -->
                    <GroupBox Header="Challenge Details" Grid.Row="0" Margin="0,0,0,10">
                        <StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <TextBlock Text="Name:" Grid.Row="0" Grid.Column="0"/>
                                <TextBox Text="{Binding ChallengeManagementViewModel.ChallengeName, UpdateSourceTrigger=PropertyChanged}" Grid.Row="0" Grid.Column="1"/>

                                <TextBlock Text="Year:" Grid.Row="0" Grid.Column="2"/>
                                <TextBox Text="{Binding ChallengeManagementViewModel.ChallengeYear}" Grid.Row="0" Grid.Column="3"/>

                                <TextBlock Text="Start Date:" Grid.Row="1" Grid.Column="0"/>
                                <DatePicker SelectedDate="{Binding ChallengeManagementViewModel.StartDate}" Grid.Row="1" Grid.Column="1"/>

                                <TextBlock Text="End Date:" Grid.Row="1" Grid.Column="2"/>
                                <DatePicker SelectedDate="{Binding ChallengeManagementViewModel.EndDate}" Grid.Row="1" Grid.Column="3"/>

                                <TextBlock Text="Description:" Grid.Row="2" Grid.Column="0"/>
                                <TextBox Text="{Binding ChallengeManagementViewModel.ChallengeDescription}" Grid.Row="2" Grid.Column="1"
                                         Grid.ColumnSpan="3" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>
                            </Grid>

                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="5,10,5,5">
                                <Button Content="Create" Command="{Binding ChallengeManagementViewModel.CreateChallengeCommand}" Width="80"/>
                                <Button Content="Update" Command="{Binding ChallengeManagementViewModel.UpdateChallengeCommand}" Width="80"/>
                                <Button Content="Delete" Command="{Binding ChallengeManagementViewModel.DeleteChallengeCommand}" Width="80" Background="#F44336" Foreground="White"/>
                                <Button Content="Clear" Command="{Binding ChallengeManagementViewModel.ClearFormCommand}" Width="80"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <!-- Challenge List and Race Events -->
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Challenges List -->
                        <GroupBox Header="Challenges" Grid.Column="0" Margin="0,0,5,0">
                            <DataGrid ItemsSource="{Binding ChallengeManagementViewModel.Challenges}"
                                     SelectedItem="{Binding ChallengeManagementViewModel.SelectedChallenge}"
                                     AutoGenerateColumns="False" IsReadOnly="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*"/>
                                    <DataGridTextColumn Header="Year" Binding="{Binding Year}" Width="60"/>
                                    <DataGridTextColumn Header="Start" Binding="{Binding StartDate, StringFormat=\{0:dd/MM/yyyy\}}" Width="90"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </GroupBox>

                        <!-- Associated Race Events -->
                        <GroupBox Header="Associated Race Events" Grid.Column="1" Margin="5,0,0,0">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <DataGrid ItemsSource="{Binding ChallengeManagementViewModel.AssociatedRaceEvents}"
                                         SelectedItem="{Binding ChallengeManagementViewModel.SelectedAssociatedEvent}"
                                         AutoGenerateColumns="False" IsReadOnly="True">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Event Name" Binding="{Binding Name}" Width="*"/>
                                        <DataGridTextColumn Header="Date" Binding="{Binding EventDate, StringFormat=\{0:dd/MM/yyyy\}}" Width="90"/>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <Button Content="Remove Event" Command="{Binding ChallengeManagementViewModel.RemoveRaceEventCommand}"
                                       Grid.Row="1" HorizontalAlignment="Right" Width="120" Margin="5"/>
                            </Grid>
                        </GroupBox>
                    </Grid>

                    <!-- Available Race Events -->
                    <GroupBox Header="Available Race Events (Add to Challenge)" Grid.Row="2" Margin="0,10,0,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <DataGrid ItemsSource="{Binding ChallengeManagementViewModel.AvailableRaceEvents}"
                                     SelectedItem="{Binding ChallengeManagementViewModel.SelectedAvailableEvent}"
                                     AutoGenerateColumns="False" IsReadOnly="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Event Name" Binding="{Binding Name}" Width="*"/>
                                    <DataGridTextColumn Header="Date" Binding="{Binding EventDate, StringFormat=\{0:dd/MM/yyyy\}}" Width="100"/>
                                    <DataGridTextColumn Header="Location" Binding="{Binding Location}" Width="150"/>
                                </DataGrid.Columns>
                            </DataGrid>

                            <Button Content="Add to Challenge" Command="{Binding ChallengeManagementViewModel.AddRaceEventCommand}"
                                   Grid.Row="1" HorizontalAlignment="Right" Width="130" Margin="5"/>
                        </Grid>
                    </GroupBox>
                </Grid>
            </TabItem>

            <!-- Race Event Management Tab -->
            <TabItem Header="Race Event Management">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Race Event Form -->
                    <GroupBox Header="Race Event Details" Grid.Row="0" Margin="0,0,0,10">
                        <StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <TextBlock Text="Event Name:" Grid.Row="0" Grid.Column="0"/>
                                <TextBox Text="{Binding RaceEventManagementViewModel.EventName, UpdateSourceTrigger=PropertyChanged}" Grid.Row="0" Grid.Column="1"/>

                                <TextBlock Text="Event Date:" Grid.Row="0" Grid.Column="2"/>
                                <DatePicker SelectedDate="{Binding RaceEventManagementViewModel.EventDate}" Grid.Row="0" Grid.Column="3"/>

                                <TextBlock Text="Location:" Grid.Row="1" Grid.Column="0"/>
                                <TextBox Text="{Binding RaceEventManagementViewModel.Location}" Grid.Row="1" Grid.Column="1"/>

                                <TextBlock Text="Website:" Grid.Row="1" Grid.Column="2"/>
                                <TextBox Text="{Binding RaceEventManagementViewModel.WebsiteUrl}" Grid.Row="1" Grid.Column="3"/>

                                <TextBlock Text="Description:" Grid.Row="2" Grid.Column="0"/>
                                <TextBox Text="{Binding RaceEventManagementViewModel.Description}" Grid.Row="2" Grid.Column="1"
                                         Grid.ColumnSpan="3" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>
                            </Grid>

                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="5,10,5,5">
                                <Button Content="Create" Command="{Binding RaceEventManagementViewModel.CreateEventCommand}" Width="80"/>
                                <Button Content="Update" Command="{Binding RaceEventManagementViewModel.UpdateEventCommand}" Width="80"/>
                                <Button Content="Delete" Command="{Binding RaceEventManagementViewModel.DeleteEventCommand}" Width="80" Background="#F44336" Foreground="White"/>
                                <Button Content="Clear" Command="{Binding RaceEventManagementViewModel.ClearFormCommand}" Width="80"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <!-- Excel Import -->
                    <GroupBox Header="Import from Excel" Grid.Row="1" Margin="0,0,0,10">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap" Margin="5">
                                <Run Text="Import multiple race events from Excel file" FontWeight="Bold"/>
                                <LineBreak/>
                                <Run Text="Expected format: Date | Race Name | Distance (km) | Location | Website | Description"/>
                                <LineBreak/>
                                <Run Text="• Distance supports decimal values (e.g., 10, 21.1, 42.195)" FontStyle="Italic"/>
                                <LineBreak/>
                                <Run Text="• Multiple rows with same event = multiple distances for same event" FontStyle="Italic"/>
                                <LineBreak/>
                                <Run Text="• Don't have a template? Click 'Export Template' to get started!" FontStyle="Italic" Foreground="#2196F3" FontWeight="Bold"/>
                            </TextBlock>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBox Text="{Binding RaceEventManagementViewModel.ImportFilePath}" IsReadOnly="True" Margin="5" Background="#F5F5F5"/>
                                <Button Content="📄 Export Template" Command="{Binding RaceEventManagementViewModel.ExportTemplateCommand}"
                                       Grid.Column="1" Width="130" Background="#FF9800" Foreground="White" 
                                       ToolTip="Download an Excel template with examples and instructions"/>
                                <Button Content="Browse..." Command="{Binding RaceEventManagementViewModel.BrowseImportFileCommand}"
                                       Grid.Column="2" Width="80"/>
                                <Button Content="Import" Command="{Binding RaceEventManagementViewModel.ImportFromExcelCommand}"
                                       Grid.Column="3" Width="80" Background="#4CAF50" Foreground="White"/>
                            </Grid>
                        </StackPanel>
                    </GroupBox>

                    <!-- Race Events List -->
                    <GroupBox Header="Race Events" Grid.Row="2">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <GroupBox Header="Events" Grid.Column="0" Margin="0,0,5,0">
                                <DataGrid ItemsSource="{Binding RaceEventManagementViewModel.RaceEvents}"
                                         SelectedItem="{Binding RaceEventManagementViewModel.SelectedRaceEvent}"
                                         AutoGenerateColumns="False" IsReadOnly="True">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Event Name" Binding="{Binding Name}" Width="*"/>
                                        <DataGridTextColumn Header="Date" Binding="{Binding EventDate, StringFormat=\{0:dd/MM/yyyy\}}" Width="100"/>
                                        <DataGridTextColumn Header="Location" Binding="{Binding Location}" Width="120"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </GroupBox>

                            <GroupBox Header="Linked Challenges" Grid.Column="1" Margin="2.5,0,2.5,0">
                                <DataGrid ItemsSource="{Binding RaceEventManagementViewModel.AssociatedChallenges}"
                                         AutoGenerateColumns="False" IsReadOnly="True">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Challenge" Binding="{Binding Name}" Width="*"/>
                                        <DataGridTextColumn Header="Year" Binding="{Binding Year}" Width="50"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </GroupBox>

                            <GroupBox Header="Available Distances" Grid.Column="2" Margin="5,0,0,0">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <DataGrid ItemsSource="{Binding RaceEventManagementViewModel.AvailableDistances}"
                                             SelectedItem="{Binding RaceEventManagementViewModel.SelectedDistance}"
                                             AutoGenerateColumns="False" IsReadOnly="True"
                                             Grid.Row="0">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Distance (km)" Binding="{Binding DistanceKm}" Width="*"/>
                                        </DataGrid.Columns>
                                    </DataGrid>

                                    <StackPanel Grid.Row="1" Margin="5">
                                        <TextBlock Text="Add Distance:" FontWeight="Bold" Margin="0,5,0,2"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBox Text="{Binding RaceEventManagementViewModel.NewDistanceKm, UpdateSourceTrigger=PropertyChanged}" 
                                                    Grid.Column="0" Margin="0,0,5,0"
                                                    ToolTip="Enter distance in km (e.g., 10 or 21.1)"/>
                                            <Button Content="Add" Command="{Binding RaceEventManagementViewModel.AddDistanceCommand}"
                                                   Grid.Column="1" Width="50"/>
                                        </Grid>
                                        <Button Content="Remove Selected" Command="{Binding RaceEventManagementViewModel.RemoveDistanceCommand}"
                                               HorizontalAlignment="Stretch" Margin="0,5,0,0" Background="#F44336" Foreground="White"/>
                                    </StackPanel>
                                </Grid>
                            </GroupBox>
                        </Grid>
                    </GroupBox>
                </Grid>
            </TabItem>

            <!-- Challenge Calendar Tab -->
            <TabItem Header="Challenge Calendar">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header and Controls -->
                    <Border Grid.Row="0" Background="#E3F2FD" Padding="15" Margin="0,0,0,10" CornerRadius="5">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Challenge Selection -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                                <TextBlock Text="Select Challenge:" FontWeight="Bold" FontSize="14" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                <ComboBox ItemsSource="{Binding ChallengeCalendarViewModel.Challenges}"
                                         SelectedItem="{Binding ChallengeCalendarViewModel.SelectedChallenge}"
                                         Width="300">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,10,0"/>
                                                <TextBlock Text="-" Margin="0,0,5,0"/>
                                                <TextBlock Text="{Binding Year}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <Button Content="🔄 Refresh" Command="{Binding ChallengeCalendarViewModel.LoadChallengesCommand}" 
                                       Width="100" Margin="10,0,0,0"/>
                                <Button Content="📅 Load Calendar" Command="{Binding ChallengeCalendarViewModel.LoadCalendarCommand}" 
                                       Width="130" Margin="10,0,0,0" Background="#2196F3" Foreground="White"/>
                            </StackPanel>

                            <!-- Export Buttons -->
                            <StackPanel Grid.Row="1" Orientation="Horizontal">
                                <TextBlock Text="Export:" FontWeight="Bold" FontSize="12" VerticalAlignment="Center" Margin="0,0,15,0"/>
                                <Button Content="📄 Export to PDF" Command="{Binding ChallengeCalendarViewModel.ExportToPdfCommand}" 
                                       Width="130" Margin="0,0,5,0" Background="#FF5722" Foreground="White"/>
                                <Button Content="📝 Export to Word" Command="{Binding ChallengeCalendarViewModel.ExportToWordCommand}" 
                                       Width="140" Margin="0,0,5,0" Background="#1976D2" Foreground="White"/>
                                <Button Content="📊 Export to Excel" Command="{Binding ChallengeCalendarViewModel.ExportToExcelCommand}" 
                                       Width="140" Margin="0,0,0,0" Background="#388E3C" Foreground="White"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Calendar Grid -->
                    <GroupBox Grid.Row="1" Header="Challenge Calendar - Race Events Ordered by Date">
                        <DataGrid ItemsSource="{Binding ChallengeCalendarViewModel.CalendarItems}"
                                 AutoGenerateColumns="False" IsReadOnly="True"
                                 AlternatingRowBackground="#F5F5F5">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Race #" Binding="{Binding RaceNumber}" Width="70">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="FontWeight" Value="Bold"/>
                                            <Setter Property="HorizontalAlignment" Value="Center"/>
                                            <Setter Property="FontSize" Value="14"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Date" Binding="{Binding EventDate, StringFormat=\{0:dd/MM/yyyy\}}" Width="100">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Event Name" Binding="{Binding EventName}" Width="*" MinWidth="200"/>
                                <DataGridTextColumn Header="Location" Binding="{Binding Location}" Width="150"/>
                                <DataGridTextColumn Header="Distances" Binding="{Binding Distances}" Width="120"/>
                                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="100">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="FontWeight" Value="Bold"/>
                                            <Setter Property="HorizontalAlignment" Value="Center"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Status}" Value="Processed">
                                                    <Setter Property="Foreground" Value="Green"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Uploaded">
                                                    <Setter Property="Foreground" Value="Orange"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Pending">
                                                    <Setter Property="Foreground" Value="Red"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Races" Binding="{Binding RaceCount}" Width="70">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Center"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </GroupBox>
                </Grid>
            </TabItem>

            <!-- Unified Mailing Tab -->
            <TabItem Header="📧 Mailing">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Mailing Type Selection -->
                    <GroupBox Grid.Row="0" Header="Type de Mailing / Mailing Type" Margin="0,0,0,10">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="5">
                                <RadioButton Content="📤 Member Mailing (Newsletter)" 
                                           IsChecked="{Binding SelectedMailingType, Converter={StaticResource StringToBoolConverter}, ConverterParameter=Member}"
                                           FontWeight="Bold" FontSize="14" Margin="0,0,30,0"/>
                                <RadioButton Content="🏆 Challenge Mailing (Classement)" 
                                           IsChecked="{Binding SelectedMailingType, Converter={StaticResource StringToBoolConverter}, ConverterParameter=Challenge}"
                                           FontWeight="Bold" FontSize="14"/>
                            </StackPanel>
                            <TextBlock Text="Select the type of mailing to send" FontStyle="Italic" Foreground="#666" Margin="5,5,5,0"/>
                        </StackPanel>
                    </GroupBox>

                    <!-- Mailing-Specific Configuration -->
                    <GroupBox Grid.Row="1" Header="Configuration" Margin="0,0,0,10">
                        <Grid>
                            <!-- Member Mailing Configuration -->
                            <StackPanel Visibility="{Binding IsMemberMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                                <!-- Mailing Date -->
                                <StackPanel Orientation="Horizontal" Margin="5">
                                    <TextBlock Text="Mailing Date:" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0" Width="120"/>
                                    <DatePicker SelectedDate="{Binding MemberMailingViewModel.MailingDate}" Width="200"/>
                                    <TextBlock Text="(Détermine les résultats et calendrier de la semaine)" 
                                              FontStyle="Italic" Foreground="#666" VerticalAlignment="Center" Margin="15,0,0,0"/>
                                </StackPanel>

                                <!-- Generate Template Button -->
                                <Button Content="📧 Generate Email Template" 
                                       Command="{Binding MemberMailingViewModel.GenerateTemplateCommand}"
                                       Background="#4CAF50" Foreground="White" FontWeight="Bold"
                                       Height="40" Margin="5,10,5,5" HorizontalAlignment="Stretch"
                                       ToolTip="Generate email with: Training schedule + Previous week results + Current week calendar"/>
                            </StackPanel>

                            <!-- Challenge Mailing Configuration -->
                            <StackPanel Visibility="{Binding IsChallengeMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                                <StackPanel Orientation="Horizontal" Margin="5">
                                    <TextBlock Text="Select Challenge:" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <ComboBox ItemsSource="{Binding ChallengeMailingViewModel.Challenges}"
                                             SelectedItem="{Binding ChallengeMailingViewModel.SelectedChallenge}"
                                             Width="300" Margin="0,0,10,0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,0,10,0"/>
                                                    <TextBlock Text="-" Margin="0,0,5,0"/>
                                                    <TextBlock Text="{Binding Year}"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <Button Content="🔄 Refresh" Command="{Binding ChallengeMailingViewModel.LoadChallengesCommand}" Width="100"/>
                                </StackPanel>

                                <!-- Generate Template Button -->
                                <Button Content="📧 Generate Email Template" 
                                       Command="{Binding ChallengeMailingViewModel.GenerateTemplateCommand}"
                                       Background="#FF9800" Foreground="White" FontWeight="Bold"
                                       Height="40" Margin="5,10,5,5" HorizontalAlignment="Stretch"
                                       ToolTip="Generate email with challenge standings"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <!-- Email Editor (Common for both) -->
                    <GroupBox Grid.Row="2" Header="Email Content" Margin="0,0,0,10">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Subject -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                                <TextBlock Text="Subject:" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0" Width="80"/>
                                <!-- Member Subject -->
                                <TextBox Text="{Binding MemberMailingViewModel.EmailSubject, UpdateSourceTrigger=PropertyChanged}" 
                                        Width="600" Height="30"
                                        Visibility="{Binding IsMemberMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                <!-- Challenge Subject -->
                                <TextBox Text="{Binding ChallengeMailingViewModel.EmailSubject, UpdateSourceTrigger=PropertyChanged}" 
                                        Width="600" Height="30"
                                        Visibility="{Binding IsChallengeMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>

                            <!-- Email Body Editor (WYSIWYG) -->
                            <Border Grid.Row="1" BorderBrush="#CCCCCC" BorderThickness="1" Margin="5" Grid.RowSpan="2">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>

                                    <!-- Toolbar -->
                                    <Border Grid.Row="0" Background="#F5F5F5" Padding="10" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1">
                                        <StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                                <TextBlock Text="✏️ Email Editor (WYSIWYG - CKEditor 4)" FontWeight="Bold" FontSize="14" VerticalAlignment="Center" Margin="0,0,15,0"/>
                                                <Button Content="🔄 Load Template" Click="LoadTemplate_Click" 
                                                       Width="120" Height="28" Margin="0,0,5,0"
                                                       ToolTip="Load the generated template into the editor"
                                                       Background="#2196F3" Foreground="White"/>
                                                <Button Content="💾 Get HTML" Click="GetHtml_Click" 
                                                       Width="100" Height="28" Margin="0,0,5,0"
                                                       ToolTip="Get the HTML from the editor"
                                                       Background="#4CAF50" Foreground="White"/>
                                                <Button Content="📊 Insert Table" Click="InsertTable_Click" 
                                                       Width="110" Height="28" Margin="0,0,5,0"
                                                       ToolTip="Insert a table at cursor position"
                                                       Background="#FF9800" Foreground="White"/>
                                            </StackPanel>
                                            <TextBlock Text="ℹ️ Professional WYSIWYG Editor - 100% Free &amp; Open Source - Full table support" 
                                                      FontStyle="Italic" Foreground="#666" FontSize="11"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- WebView2 for CKEditor -->
                                    <Border Grid.Row="1" BorderBrush="#E0E0E0" BorderThickness="1,0,0,0">
                                        <Grid x:Name="WebViewContainer">
                                            <!-- WebView2 will be added programmatically -->
                                        </Grid>
                                    </Border>
                                </Grid>
                            </Border>
                        </Grid>
                    </GroupBox>

                    <!-- Send Actions (Common for both) -->
                    <GroupBox Grid.Row="3" Header="Send Actions">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Test Email -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="Test Email:" FontWeight="Bold" VerticalAlignment="Center" Margin="5"/>
                                <!-- Member Test Email -->
                                <TextBox Text="{Binding MemberMailingViewModel.TestEmailAddress, UpdateSourceTrigger=PropertyChanged}" 
                                        Width="250" Margin="5"
                                        Visibility="{Binding IsMemberMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                <Button Content="📧 Send Test" Command="{Binding MemberMailingViewModel.SendTestEmailCommand}"
                                       Background="#2196F3" Foreground="White" Margin="5" Width="120"
                                       Visibility="{Binding IsMemberMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>

                                <!-- Challenge Test Email -->
                                <TextBox Text="{Binding ChallengeMailingViewModel.TestEmailAddress, UpdateSourceTrigger=PropertyChanged}" 
                                        Width="250" Margin="5"
                                        Visibility="{Binding IsChallengeMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                <Button Content="📧 Send Test" Command="{Binding ChallengeMailingViewModel.SendTestEmailCommand}"
                                       Background="#2196F3" Foreground="White" Margin="5" Width="120"
                                       Visibility="{Binding IsChallengeMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>

                            <!-- Send to All Button -->
                            <!-- Member Send Button -->
                            <Button Grid.Column="1" Content="📤 Send to All Members" 
                                   Command="{Binding MemberMailingViewModel.SendToAllMembersCommand}"
                                   Background="#FF9800" Foreground="White" FontWeight="Bold"
                                   Width="200" Margin="5"
                                   Visibility="{Binding IsMemberMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}"
                                   ToolTip="Send to all members from Members.json"/>

                            <!-- Challenge Send Button -->
                            <Button Grid.Column="1" Content="📤 Send to All Challengers" 
                                   Command="{Binding ChallengeMailingViewModel.SendToAllChallengersCommand}"
                                   Background="#4CAF50" Foreground="White" FontWeight="Bold"
                                   Width="200" Margin="5"
                                   Visibility="{Binding IsChallengeMailingSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>

                            <!-- Progress Indicator -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                <!-- Member Sending -->
                                <StackPanel Orientation="Horizontal"
                                           Visibility="{Binding MemberMailingViewModel.IsSending, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <ProgressBar IsIndeterminate="True" Width="100" Height="20" Margin="5"/>
                                    <TextBlock Text="Sending..." VerticalAlignment="Center" FontStyle="Italic"/>
                                </StackPanel>

                                <!-- Challenge Sending -->
                                <StackPanel Orientation="Horizontal"
                                           Visibility="{Binding ChallengeMailingViewModel.IsSending, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <ProgressBar IsIndeterminate="True" Width="100" Height="20" Margin="5"/>
                                    <TextBlock Text="Sending..." VerticalAlignment="Center" FontStyle="Italic"/>
                                </StackPanel>
                            </StackPanel>
                        </Grid>
                    </GroupBox>
                </Grid>
            </TabItem>


                                    </TabControl>

                                    <!-- Status Bar -->
                                    <Border Grid.Row="2" Background="#EEEEEE" Padding="10" Margin="0,10,0,0">
                                        <TextBlock Text="{Binding StatusMessage}" FontStyle="Italic" Foreground="#666666"/>
                                    </Border>
                                </Grid>
                            </Window>